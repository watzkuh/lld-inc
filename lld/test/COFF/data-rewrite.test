# RUN: rm -rf %t.dir
# RUN: mkdir %t.dir
# RUN: yaml2obj %p/Inputs/extern-data.yaml > %t.dir/extern-data.obj
# RUN: yaml2obj %p/Inputs/function.yaml > %t.dir/function.obj
# RUN: lld-link /out:%t.dir/inc.exe /opt:noref /entry:main /nodefaultlib /incrementallink \
# RUN:   %t.dir/extern-data.obj %t.dir/function.obj | FileCheck %s

CHECK: No incremental

# RUN: llvm-readobj --sections --section-data %t.dir/inc.exe > %t.dir/clean-link
# RUN: yaml2obj %p/Inputs/extern-data-modified.yaml > %t.dir/extern-data.obj
# RUN: lld-link /out:%t.dir/inc.exe /opt:noref /entry:main /nodefaultlib /incrementallink \
# RUN:   %t.dir/extern-data.obj %t.dir/function.obj | FileCheck --check-prefix=INC %s

INC: Attempting incremental link
INC-NOT: function.obj has changed
INC-NEXT: extern-data.obj has changed
INC: Rewriting .data section
INC: Rewriting .text section

# RUN: llvm-readobj --sections --section-data %t.dir/inc.exe > %t.dir/incremental-link
# RUN: not diff %t.dir/clean-link %t.dir/incremental-link | FileCheck --check-prefix=DIFF %s

DIFF: 71c71
DIFF-NEXT: <       0000: 48656C6C 6F20576F 726C642E 0A000000  |Hello World.....|
DIFF-NEXT: ---
DIFF-NEXT: >       0000: 48656C6C 6F204C6F 72656D2E 0A000000  |Hello Lorem.....|
DIFF-NOT: ---